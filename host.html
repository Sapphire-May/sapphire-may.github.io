    <!-- Firebase compat builds -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <script>
      // === YOUR FIREBASE CONFIG ====================================
      const firebaseConfig = {
        apiKey: "AIzaSyCPHd62hm96T9kcy1ZqWUhFu1WN8A0Mwj4",
        authDomain: "audio-8c1f6.firebaseapp.com",
        databaseURL: "https://audio-8c1f6-default-rtdb.firebaseio.com", // <-- important
        projectId: "audio-8c1f6",
        storageBucket: "audio-8c1f6.firebasestorage.app",
        messagingSenderId: "313094779274",
        appId: "1:313094779274:web:8394e80c777f11fd6e9873"
      };
      // ============================================================

      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      // UI elements
      const roomInput = document.getElementById("room-id");
      const btnStartHost = document.getElementById("btn-start-host");
      const hostSetupStatus = document.getElementById("host-setup-status");

      const tracksCard = document.getElementById("tracks-card");
      const filenamesTextarea = document.getElementById("filenames");
      const btnSendTracks = document.getElementById("btn-send-tracks");

      const roomInfo = document.getElementById("room-info");
      const hostConnDot = document.getElementById("host-conn-dot");
      const hostConnText = document.getElementById("host-conn-text");
      const listenerLinkEl = document.getElementById("listener-link");

      const controlCard = document.getElementById("control-card");
      const readyStatus = document.getElementById("ready-status");
      const btnPlay = document.getElementById("btn-play");
      const btnPause = document.getElementById("btn-pause");
      const trackListEl = document.getElementById("track-list");
      const activeTrackLabel = document.getElementById("active-track-label");
      const hostStatus = document.getElementById("host-status");

      // State
      let currentRoomId = null;
      let roomRef = null;

      let tracks = []; // { id, filename, label }
      const audioMap = {}; // id -> HTMLAudioElement
      const readyMap = {}; // id -> boolean
      let readyCount = 0;

      let currentState = { activeTrackId: null, playing: false };

      function setHostConnectionStatus(online) {
        if (online) {
          hostConnDot.classList.add("online");
          hostConnText.textContent = "Hosting room";
        } else {
          hostConnDot.classList.remove("online");
          hostConnText.textContent = "Not connected";
        }
      }

      function randomId() {
        return (
          Date.now().toString(36) +
          "-" +
          Math.random().toString(36).slice(2)
        );
      }

      function getAudioBaseUrl() {
        // Root site: https://sapphire-may.github.io/
        return window.location.origin + "/audio/";
      }

      btnStartHost.addEventListener("click", async () => {
        const roomId = roomInput.value.trim();
        if (!roomId) {
          alert("Please enter a room ID first.");
          return;
        }
        currentRoomId = roomId;
        await startHost(roomId);
      });

      btnSendTracks.addEventListener("click", async () => {
        const text = filenamesTextarea.value;
        const lines = text
          .split("\n")
          .map((l) => l.trim())
          .filter((l) => l.length > 0);
        if (!lines.length) {
          alert("Enter at least one filename.");
          return;
        }

        tracks = lines.map((line) => {
          const parts = line.split("|");
          const filename = parts[0].trim();
          const label =
            (parts[1] && parts[1].trim()) || filename;
          return {
            id: randomId(),
            filename,
            label
          };
        });

        const tracksObj = {};
        tracks.forEach((t) => {
          tracksObj[t.id] = {
            filename: t.filename,
            label: t.label
          };
        });

        await roomRef.child("tracks").set(tracksObj);

        prepareLocalAudio(tracks);

        controlCard.style.display = "block";
        renderTrackList();
        hostStatus.textContent =
          "Track list sent. Waiting for buffers to fill.";
      });

      async function startHost(roomId) {
        setHostConnectionStatus(false);
        hostSetupStatus.textContent = "Connecting as hostâ€¦";

        roomRef = db.ref("rooms").child(roomId);

        await roomRef.child("host").set({
          online: true,
          ts: firebase.database.ServerValue.TIMESTAMP
        });
        roomRef
          .child("host")
          .onDisconnect()
          .remove()
          .catch(() => {});

        const listenerUrl =
          window.location.origin +
          "/listener.html?room=" +
          encodeURIComponent(roomId);

        roomInfo.style.display = "block";
        listenerLinkEl.innerHTML =
          'Listener link: <span class="highlight">' +
          listenerUrl +
          "</span>";
        tracksCard.style.display = "block";
        setHostConnectionStatus(true);
        hostSetupStatus.textContent =
          'Hosting room "' +
          roomId +
          '". Enter filenames and send tracks.';

        roomRef.child("state").on("value", (snap) => {
          const val = snap.val() || {};
          currentState = {
            activeTrackId: val.activeTrackId || null,
            playing: !!val.playing
          };
          applyPlaybackState();
        });
      }

      function prepareLocalAudio(trackList) {
        const base = getAudioBaseUrl();
        readyCount = 0;
        for (const id in readyMap) {
          delete readyMap[id];
        }

        trackList.forEach((track) => {
          const url = base + track.filename;
          let audio = audioMap[track.id];
          if (!audio) {
            audio = new Audio();
            audioMap[track.id] = audio;
            audio.preload = "auto";
            audio.addEventListener("canplaythrough", () => {
              if (!readyMap[track.id]) {
                readyMap[track.id] = true;
                readyCount++;
                updateReadyStatus();
              }
            });
            audio.addEventListener("error", () => {
              hostStatus.textContent =
                "Error loading " +
                track.filename +
                ". Check that it exists in audio/ and is accessible.";
            });
          }
          audio.src = url;
          audio.load();
        });
        updateReadyStatus();
      }

      function updateReadyStatus() {
        const total = tracks.length;
        if (!total) {
          readyStatus.textContent = "No tracks listed yet.";
          btnPlay.disabled = true;
          btnPause.disabled = true;
          return;
        }
        readyStatus.textContent =
          "Buffered tracks: " + readyCount + " / " + total;
        const anyReady = Object.values(readyMap).some(Boolean);
        btnPlay.disabled = !anyReady;
        btnPause.disabled = !anyReady;
      }

      function renderTrackList() {
        trackListEl.innerHTML = "";
        if (!tracks.length) {
          trackListEl.style.display = "none";
          activeTrackLabel.textContent = "none";
          return;
        }
        trackListEl.style.display = "block";

        tracks.forEach((track) => {
          const row = document.createElement("div");
          row.className = "track-row";

          const left = document.createElement("div");
          const badge = document.createElement("span");
          badge.className = "track-badge";
          if (track.id === currentState.activeTrackId) {
            badge.classList.add("active");
            badge.textContent = "Active";
          } else {
            badge.textContent = "Idle";
          }

          const nameSpan = document.createElement("span");
          nameSpan.className = "track-name";
          nameSpan.textContent = track.label;

          left.appendChild(badge);
          left.appendChild(nameSpan);

          const switchBtn = document.createElement("button");
          switchBtn.textContent = "Make active";
          switchBtn.addEventListener("click", () => {
            setActiveTrack(track.id);
          });

          row.appendChild(left);
          row.appendChild(switchBtn);

          trackListEl.appendChild(row);
        });

        const active = tracks.find(
          (t) => t.id === currentState.activeTrackId
        );
        activeTrackLabel.textContent = active
          ? active.label
          : "none";
      }

      function setActiveTrack(id) {
        if (!tracks.find((t) => t.id === id)) return;
        currentState.activeTrackId = id;
        roomRef.child("state").update({
          activeTrackId: id,
          playing: currentState.playing
        });
        renderTrackList();
        if (currentState.playing) {
          hostStatus.textContent =
            "Switched active track. Listeners should hear it immediately.";
        } else {
          hostStatus.textContent =
            "Active track changed. Will play when you press Play.";
        }
      }

      btnPlay.addEventListener("click", () => {
        if (!tracks.length) return;
        if (!currentState.activeTrackId) {
          currentState.activeTrackId = tracks[0].id;
        }
        currentState.playing = true;
        roomRef.child("state").set(currentState);
        hostStatus.textContent =
          "Play command sent. Listeners will start playback.";
        renderTrackList();
      });

      btnPause.addEventListener("click", () => {
        currentState.playing = false;
        roomRef.child("state").update({
          playing: false
        });
        hostStatus.textContent =
          "Pause command sent. Listeners will stop playback.";
      });

      function applyPlaybackState() {
        const { activeTrackId, playing } = currentState;
        tracks.forEach((track) => {
          const audio = audioMap[track.id];
          if (!audio) return;
          if (
            playing &&
            track.id === activeTrackId &&
            readyMap[track.id]
          ) {
            audio.play().catch(() => {});
          } else {
            audio.pause();
          }
        });
        renderTrackList();
      }
    </script>
